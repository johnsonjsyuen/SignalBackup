<?xml version="1.0" encoding="utf-8"?>
<!--
  AndroidManifest.xml - Application manifest declaring permissions, components, and configuration.

  This file tells the Android system everything it needs to know about the app:
  - What permissions it requires.
  - What components it contains (Activities, Services, Providers).
  - How to launch the app (intent filters).
  - Custom initialization overrides (WorkManager).

  Permissions:
  - INTERNET: Required for Google Drive API calls (uploading files, listing folders).
  - FOREGROUND_SERVICE: Required to promote the UploadWorker to a foreground service
    so it can show a notification during long-running uploads (Android 8+ requirement).
  - FOREGROUND_SERVICE_DATA_SYNC: Android 14+ requires declaring the specific foreground
    service type. DATA_SYNC indicates the service is syncing data to the cloud.
  - POST_NOTIFICATIONS: Android 13+ requires runtime permission to show notifications.
    The foreground service notification needs this permission.

  WorkManager initialization:
  By default, WorkManager is initialized automatically via the AndroidX Startup library
  (InitializationProvider). We DISABLE this default initializer because we need Hilt-based
  initialization to support @HiltWorker dependency injection. Instead, our custom
  Application class (SignalBackupApp) implements Configuration.Provider and provides
  the WorkManager configuration with HiltWorkerFactory.
  The tools:node="remove" attribute on the meta-data element removes the default
  initializer from the merged manifest.

  @see SignalBackupApp for the custom WorkManager initialization
  @see worker.UploadWorker for the foreground service that uses these permissions
-->
<manifest xmlns:android="http://schemas.android.com/apk/res/android"
    xmlns:tools="http://schemas.android.com/tools">

    <!-- Network access for Google Drive API calls. -->
    <uses-permission android:name="android.permission.INTERNET" />
    <!-- Required to run the upload worker as a foreground service with a notification. -->
    <uses-permission android:name="android.permission.FOREGROUND_SERVICE" />
    <!-- Android 14+ requires declaring the foreground service type (data sync = cloud upload). -->
    <uses-permission android:name="android.permission.FOREGROUND_SERVICE_DATA_SYNC" />
    <!-- Android 13+ requires permission to show notifications (used by the upload worker). -->
    <uses-permission android:name="android.permission.POST_NOTIFICATIONS" />
    <!-- Required to acquire a WakeLock so the CPU stays awake during large uploads. -->
    <uses-permission android:name="android.permission.WAKE_LOCK" />
    <!-- Required to acquire a WiFi lock so the network stays active during large uploads. -->
    <uses-permission android:name="android.permission.ACCESS_WIFI_STATE" />
    <uses-permission android:name="android.permission.RECEIVE_BOOT_COMPLETED" />
    <uses-permission android:name="android.permission.SCHEDULE_EXACT_ALARM" />

    <application
        android:name=".SignalBackupApp"
        android:allowBackup="false"
        android:icon="@mipmap/ic_launcher"
        android:label="@string/app_name"
        android:supportsRtl="true"
        android:theme="@style/Theme.SignalBackup">

        <!--
          Declare the foreground service type for WorkManager's SystemForegroundService.
          On Android 14+ (API 34+), any foreground service must declare its type in the manifest.
          WorkManager's library manifest includes the service declaration but NOT the
          foregroundServiceType attribute. Without this, setForeground() with
          FOREGROUND_SERVICE_TYPE_DATA_SYNC throws MissingForegroundServiceTypeException.
          tools:node="merge" merges our attribute into the existing library-declared service.
        -->
        <service
            android:name="androidx.work.impl.foreground.SystemForegroundService"
            android:foregroundServiceType="dataSync"
            tools:node="merge" />

        <!--
          Disable the default WorkManager initializer.
          WorkManager normally auto-initializes via AndroidX Startup's InitializationProvider.
          We override this because we need Hilt-based initialization (HiltWorkerFactory)
          to support dependency injection in our @HiltWorker UploadWorker.
          tools:node="merge" merges our changes into the provider declaration.
          tools:node="remove" on the meta-data element removes the specific initializer.
        -->
        <provider
            android:name="androidx.startup.InitializationProvider"
            android:authorities="${applicationId}.androidx-startup"
            android:exported="false"
            tools:node="merge">
            <meta-data
                android:name="androidx.work.WorkManagerInitializer"
                android:value="androidx.startup"
                tools:node="remove" />
        </provider>

        <receiver
            android:name=".receiver.UploadAlarmReceiver"
            android:exported="false" />

        <receiver
            android:name=".receiver.BootCompletedReceiver"
            android:exported="true"
            android:permission="android.permission.RECEIVE_BOOT_COMPLETED">
            <intent-filter>
                <action android:name="android.intent.action.BOOT_COMPLETED" />
            </intent-filter>
        </receiver>

        <!--
          The single Activity that hosts the entire Compose UI.
          android:exported="true" is required for the LAUNCHER intent filter.
          The intent filter makes this the app's launch Activity.
        -->
        <activity
            android:name=".MainActivity"
            android:exported="true"
            android:theme="@style/Theme.SignalBackup">
            <intent-filter>
                <action android:name="android.intent.action.MAIN" />
                <category android:name="android.intent.category.LAUNCHER" />
            </intent-filter>
        </activity>
    </application>

</manifest>
